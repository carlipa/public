var LZString={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",_f:String.fromCharCode,compressToBase64:function(r){if(null==r)return"";var e,t,a,o,i,n,s,c="",p=0;for(r=LZString.compress(r);p<2*r.length;)p%2==0?(e=r.charCodeAt(p/2)>>8,t=255&r.charCodeAt(p/2),a=p/2+1<r.length?r.charCodeAt(p/2+1)>>8:0/0):(e=255&r.charCodeAt((p-1)/2),(p+1)/2<r.length?(t=r.charCodeAt((p+1)/2)>>8,a=255&r.charCodeAt((p+1)/2)):t=a=0/0),p+=3,o=e>>2,i=(3&e)<<4|t>>4,n=(15&t)<<2|a>>6,s=63&a,isNaN(t)?n=s=64:isNaN(a)&&(s=64),c=c+LZString._keyStr.charAt(o)+LZString._keyStr.charAt(i)+LZString._keyStr.charAt(n)+LZString._keyStr.charAt(s);return c},decompressFromBase64:function(r){if(null==r)return"";var e,t,a,o,i,n,s,c,p="",f=0,h=0,l=LZString._f;for(r=r.replace(/[^A-Za-z0-9\+\/\=]/g,"");h<r.length;)i=LZString._keyStr.indexOf(r.charAt(h++)),n=LZString._keyStr.indexOf(r.charAt(h++)),s=LZString._keyStr.indexOf(r.charAt(h++)),c=LZString._keyStr.indexOf(r.charAt(h++)),t=i<<2|n>>4,a=(15&n)<<4|s>>2,o=(3&s)<<6|c,f%2==0?(e=t<<8,64!=s&&(p+=l(e|a)),64!=c&&(e=o<<8)):(p+=l(e|t),64!=s&&(e=a<<8),64!=c&&(p+=l(e|o))),f+=3;return LZString.decompress(p)},compressToUTF16:function(r){if(null==r)return"";var e,t,a,o="",i=0,n=LZString._f;for(r=LZString.compress(r),e=0;e<r.length;e++)switch(t=r.charCodeAt(e),i++){case 0:o+=n((t>>1)+32),a=(1&t)<<14;break;case 1:o+=n(a+(t>>2)+32),a=(3&t)<<13;break;case 2:o+=n(a+(t>>3)+32),a=(7&t)<<12;break;case 3:o+=n(a+(t>>4)+32),a=(15&t)<<11;break;case 4:o+=n(a+(t>>5)+32),a=(31&t)<<10;break;case 5:o+=n(a+(t>>6)+32),a=(63&t)<<9;break;case 6:o+=n(a+(t>>7)+32),a=(127&t)<<8;break;case 7:o+=n(a+(t>>8)+32),a=(255&t)<<7;break;case 8:o+=n(a+(t>>9)+32),a=(511&t)<<6;break;case 9:o+=n(a+(t>>10)+32),a=(1023&t)<<5;break;case 10:o+=n(a+(t>>11)+32),a=(2047&t)<<4;break;case 11:o+=n(a+(t>>12)+32),a=(4095&t)<<3;break;case 12:o+=n(a+(t>>13)+32),a=(8191&t)<<2;break;case 13:o+=n(a+(t>>14)+32),a=(16383&t)<<1;break;case 14:o+=n(a+(t>>15)+32,(32767&t)+32),i=0}return o+n(a+32)},decompressFromUTF16:function(r){if(null==r)return"";for(var e,t,a="",o=0,i=0,n=LZString._f;i<r.length;){switch(t=r.charCodeAt(i)-32,o++){case 0:e=t<<1;break;case 1:a+=n(e|t>>14),e=(16383&t)<<2;break;case 2:a+=n(e|t>>13),e=(8191&t)<<3;break;case 3:a+=n(e|t>>12),e=(4095&t)<<4;break;case 4:a+=n(e|t>>11),e=(2047&t)<<5;break;case 5:a+=n(e|t>>10),e=(1023&t)<<6;break;case 6:a+=n(e|t>>9),e=(511&t)<<7;break;case 7:a+=n(e|t>>8),e=(255&t)<<8;break;case 8:a+=n(e|t>>7),e=(127&t)<<9;break;case 9:a+=n(e|t>>6),e=(63&t)<<10;break;case 10:a+=n(e|t>>5),e=(31&t)<<11;break;case 11:a+=n(e|t>>4),e=(15&t)<<12;break;case 12:a+=n(e|t>>3),e=(7&t)<<13;break;case 13:a+=n(e|t>>2),e=(3&t)<<14;break;case 14:a+=n(e|t>>1),e=(1&t)<<15;break;case 15:a+=n(e|t),o=0}i++}return LZString.decompress(a)},compress:function(r){if(null==r)return"";var e,t,a,o={},i={},n="",s="",c="",p=2,f=3,h=2,l="",d=0,k=0,b=LZString._f;for(a=0;a<r.length;a+=1)if(n=r.charAt(a),Object.prototype.hasOwnProperty.call(o,n)||(o[n]=f++,i[n]=!0),s=c+n,Object.prototype.hasOwnProperty.call(o,s))c=s;else{if(Object.prototype.hasOwnProperty.call(i,c)){if(c.charCodeAt(0)<256){for(e=0;h>e;e++)d<<=1,15==k?(k=0,l+=b(d),d=0):k++;for(t=c.charCodeAt(0),e=0;8>e;e++)d=d<<1|1&t,15==k?(k=0,l+=b(d),d=0):k++,t>>=1}else{for(t=1,e=0;h>e;e++)d=d<<1|t,15==k?(k=0,l+=b(d),d=0):k++,t=0;for(t=c.charCodeAt(0),e=0;16>e;e++)d=d<<1|1&t,15==k?(k=0,l+=b(d),d=0):k++,t>>=1}p--,0==p&&(p=Math.pow(2,h),h++),delete i[c]}else for(t=o[c],e=0;h>e;e++)d=d<<1|1&t,15==k?(k=0,l+=b(d),d=0):k++,t>>=1;p--,0==p&&(p=Math.pow(2,h),h++),o[s]=f++,c=String(n)}if(""!==c){if(Object.prototype.hasOwnProperty.call(i,c)){if(c.charCodeAt(0)<256){for(e=0;h>e;e++)d<<=1,15==k?(k=0,l+=b(d),d=0):k++;for(t=c.charCodeAt(0),e=0;8>e;e++)d=d<<1|1&t,15==k?(k=0,l+=b(d),d=0):k++,t>>=1}else{for(t=1,e=0;h>e;e++)d=d<<1|t,15==k?(k=0,l+=b(d),d=0):k++,t=0;for(t=c.charCodeAt(0),e=0;16>e;e++)d=d<<1|1&t,15==k?(k=0,l+=b(d),d=0):k++,t>>=1}p--,0==p&&(p=Math.pow(2,h),h++),delete i[c]}else for(t=o[c],e=0;h>e;e++)d=d<<1|1&t,15==k?(k=0,l+=b(d),d=0):k++,t>>=1;p--,0==p&&(p=Math.pow(2,h),h++)}for(t=2,e=0;h>e;e++)d=d<<1|1&t,15==k?(k=0,l+=b(d),d=0):k++,t>>=1;for(;;){if(d<<=1,15==k){l+=b(d);break}k++}return l},decompress:function(r){if(null==r)return"";if(""==r)return null;var e,t,a,o,i,n,s,c,p=[],f=4,h=4,l=3,d="",k="",b=LZString._f,g={string:r,val:r.charCodeAt(0),position:32768,index:1};for(t=0;3>t;t+=1)p[t]=t;for(o=0,n=Math.pow(2,2),s=1;s!=n;)i=g.val&g.position,g.position>>=1,0==g.position&&(g.position=32768,g.val=g.string.charCodeAt(g.index++)),o|=(i>0?1:0)*s,s<<=1;switch(e=o){case 0:for(o=0,n=Math.pow(2,8),s=1;s!=n;)i=g.val&g.position,g.position>>=1,0==g.position&&(g.position=32768,g.val=g.string.charCodeAt(g.index++)),o|=(i>0?1:0)*s,s<<=1;c=b(o);break;case 1:for(o=0,n=Math.pow(2,16),s=1;s!=n;)i=g.val&g.position,g.position>>=1,0==g.position&&(g.position=32768,g.val=g.string.charCodeAt(g.index++)),o|=(i>0?1:0)*s,s<<=1;c=b(o);break;case 2:return""}for(p[3]=c,a=k=c;;){if(g.index>g.string.length)return"";for(o=0,n=Math.pow(2,l),s=1;s!=n;)i=g.val&g.position,g.position>>=1,0==g.position&&(g.position=32768,g.val=g.string.charCodeAt(g.index++)),o|=(i>0?1:0)*s,s<<=1;switch(c=o){case 0:for(o=0,n=Math.pow(2,8),s=1;s!=n;)i=g.val&g.position,g.position>>=1,0==g.position&&(g.position=32768,g.val=g.string.charCodeAt(g.index++)),o|=(i>0?1:0)*s,s<<=1;p[h++]=b(o),c=h-1,f--;break;case 1:for(o=0,n=Math.pow(2,16),s=1;s!=n;)i=g.val&g.position,g.position>>=1,0==g.position&&(g.position=32768,g.val=g.string.charCodeAt(g.index++)),o|=(i>0?1:0)*s,s<<=1;p[h++]=b(o),c=h-1,f--;break;case 2:return k}if(0==f&&(f=Math.pow(2,l),l++),p[c])d=p[c];else{if(c!==h)return null;d=a+a.charAt(0)}k+=d,p[h++]=a+d.charAt(0),f--,a=d,0==f&&(f=Math.pow(2,l),l++)}}};"undefined"!=typeof module&&null!=module&&(module.exports=LZString);(function(window,document,console,undefined){"use strict";var noop=function(){};var slice=Array.prototype.slice;var isDefined=function(obj){return typeof obj!=="undefined"};var slugify=function(str){return(str+"").toLowerCase().replace(/\W/g,"_")};var extend=function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(source.hasOwnProperty(key))target[key]=source[key]}}return target};var debug=console.debug.bind(console);var matches=navigator.userAgent.match(/iPhone OS (\d)_?(\d)? like Mac OS X/);var ios=matches?matches.slice(1).map(Number):false;var indexedDB=window.shimIndexedDB||window.indexedDB;var options={database:"analytics",collection:"metrics",endpoint:"https://analytics.carlipa-online.com/dev",exclude:false,debug:false,mock:false,query:true,reset:false,retry:10*60*1e3,debounce:1*1e3,limit:20,version:1};var $db={};$db.$buffer={};$db.open=function(database,collection,callback){var version=options.version;debug('Opening collection="%s" on database="%s"',collection,database);var request=indexedDB.open(database,version);$db.$buffer[collection]=[];request.onupgradeneeded=function(evt){var db=evt.target.result;evt.target.transaction.onerror=$db.onerror;if(db.objectStoreNames.contains(collection)){db.deleteObjectStore(collection)}var store=db.createObjectStore(collection,{keyPath:"key"})};request.onsuccess=function(evt){var db=evt.target.result;$db.instance=db;processBuffer();(callback||noop).apply(db)};request.onerror=$db.onerror};function processBuffer(){Object.keys($db.$buffer).forEach(function(collection){if($db.$buffer[collection]&&$db.$buffer[collection].length){$db.$buffer[collection].forEach(function(buffered){$db.put(collection,buffered.item,buffered.callback)});$db.$buffer[collection]=[]}})}$db.put=function(collection,item,callback){if(!$db.instance)return $db.$buffer[collection].push({item:item,callback:callback||noop});var db=$db.instance;var trans=db.transaction([collection],"readwrite");var store=trans.objectStore(collection);var request=store.put(item);request.onsuccess=callback||noop;request.onerror=$db.onerror};$db.get=function(collection,config,callback){if(typeof config==="function"){callback=config;config={}}if(!$db.instance)return[];var db=$db.instance;var trans=db.transaction([collection],"readwrite");var store=trans.objectStore(collection);callback=callback||noop;var keyRange=IDBKeyRange.lowerBound(0);var request=store.openCursor(keyRange);var results=[];var limit=config.limit||0;request.onsuccess=function(evt){var result=evt.target.result;if(result)results.push(result.value);if(!result||limit&&results.length>=limit){return callback.apply(db,[null,results])}result.continue()};request.onerror=function(err){return callback.apply(db,[err])}};$db.delete=function(collection,records,callback){if(!$db.instance)return false;var db=$db.instance;var trans=db.transaction([collection],"readwrite");var store=trans.objectStore(collection);callback=callback||noop;var results=[];var resultFn=function(success,index){return function(evt){results.push(!!success);if(index===records.length-1){if(results.filter(Boolean).length===records.length){return callback.apply(db,[null,records.length])}else{return callback.apply(db,[evt,null])}}}};records.forEach(function(id,index){var request=store.delete(id);request.onsuccess=resultFn(true,index);request.onerror=resultFn(false,index)})};$db.onerror=function(err){throw err.value};var $analytics={};var interval;$analytics.$defaults={type:"event",value:1};$analytics.initialize=function(config){extend(options,config);if(options.exclude&&location.host.match(options.exclude))return;$analytics.clientId=ucid();options.database=options.trackingId||options.database;$analytics.trackingId=config.trackingId;if(options.reset)indexedDB.deleteDatabase(options.database);if(options.query)$analytics.identify(deparam(window.location.search));if(options.identity)$analytics.identify(options.identity);if(!options.debug)debug=noop;$db.open(options.database,options.collection,function(){debug('Successfully opened database="%s", with identity=%o',options.database,$analytics.$identity)})};$analytics.track=function(name,config){if(!$analytics.trackingId)return;var metric=extend({},$analytics.$defaults,$analytics.$identity,config);metric.time=+new Date;metric.name=name;metric.key=metric.time+":"+metric.type+":"+slugify(metric.name);if(metric.item)metric.key+=":"+slugify(metric.item);if(options.mock)return debug('Successfully stored metric="%s"',metric.name,metric);return $db.put(options.collection,metric,function(){debug('Successfully stored metric="%s"',metric.name,metric);$analytics.$push()})};$analytics.$$push=function(){var url=options.endpoint+"/"+$analytics.trackingId+"/collect";url+="?v="+options.version;url+=$analytics.clientId?"&cid="+encodeURIComponent($analytics.clientId):"";$db.get("metrics",{limit:options.limit},function(err,results){if(err)return debug("Failed to read %d-metrics",options.limit)&&false;if(!results.length)return debug("No new metrics to post")&&false;var string=JSON.stringify(results);var compressed=LZString.compressToUTF16(string);debug("Compressed %d-results by %d%%",results.length,Math.floor(100*(1-compressed.length/string.length)));var buffer=str2buffer(compressed);request("post",url,buffer,{"content-type":"application/octet-stream"},function(err,success){if(err){if(options.retry&&!interval)interval=setInterval($analytics.$push,options.retry);return debug("Failed to post %d-metrics",results.length)&&false}if(interval){clearInterval(interval);interval=null}debug("Successfully posted %d-metrics",results.length);var keys=results.map(function(obj){return obj.key});$db.delete("metrics",keys,function(err,count){if(err)return debug("Failed to delete %d-metrics",keys.length)&&false;debug("Successfully deleted %d-metrics",keys.length);if(options.limit&&results.length===options.limit){$analytics.$push()}})})})};$analytics.$push=debounce($analytics.$$push,options.debounce);$analytics.$identity=identity();$analytics.identify=function(payload){if(!payload||!Object.keys(payload).length)return;extend($analytics.$identity,payload);localStorage.setItem("_identity",JSON.stringify($analytics.$identity));debug("Updated identity=%o",$analytics.$identity)};window.analytics=$analytics;document.addEventListener("online",function(){$analytics.$push()},false);function request(method,url,data,headers,callback){var xhr=new XMLHttpRequest;callback=callback||noop;xhr.open(method.toUpperCase(),url,true);headers&&Object.keys(headers).forEach(function(key){if(isDefined(headers[key]))xhr.setRequestHeader(key,headers[key])});xhr.onreadystatechange=function(){if(xhr&&xhr.readyState===4){var responseHeaders=xhr.getAllResponseHeaders();var response="response"in xhr?xhr.response:xhr.responseText;if(xhr.status&&xhr.status<400){callback.apply(xhr,[null,{data:response,headers:responseHeaders}])}else{callback.apply(xhr,[{data:response,headers:responseHeaders}])}}};xhr.send(data);return xhr}function deparam(querystring){querystring=querystring.substring(querystring.indexOf("?")+1).split("&");var params={},pair,d=decodeURIComponent;for(var i=querystring.length-1;i>=0;i--){pair=querystring[i].split("=");if(!d(pair[0]))continue;params[d(pair[0])]=d(pair[1])}return params}function str2buffer(str){var arraybuffer=new ArrayBuffer(str.length*2);var buffer=new Uint16Array(arraybuffer);for(var i=0,strLen=str.length;i<strLen;i++){buffer[i]=str.charCodeAt(i)}return ios&&ios[0]<7?arraybuffer:buffer}function debounce(func,wait,immediate){var timeout,args,context,timestamp,result;return function(){context=this;args=arguments;timestamp=new Date;var later=function(){var last=new Date-timestamp;if(last<wait){timeout=setTimeout(later,wait-last)}else{timeout=null;if(!immediate)result=func.apply(context,args)}};var callNow=immediate&&!timeout;if(!timeout){timeout=setTimeout(later,wait)}if(callNow)result=func.apply(context,args);return result}}function s4(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}function guid(){return s4()+s4()+s4()+s4()+s4()+s4()}function identity(){var _identity=localStorage.getItem("_identity");if(!_identity){_identity={};localStorage.setItem("_identity",JSON.stringify(_identity))}else{_identity=JSON.parse(_identity)}return _identity}function ucid(){var _ucid=localStorage.getItem("_ucid");if(!_ucid){_ucid=guid();localStorage.setItem("_ucid",_ucid)}return _ucid}})(window,document,window.console);
//# sourceMappingURL=dist/analytics.map.js